<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Profile | Crave Cart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% load static %}
  <link rel="stylesheet" href="{% static 'css/profile.css' %}">
  <link rel="stylesheet" href="{% static 'css/custom_show_style.css' %}">
</head>
<body>

  <!-- Header -->
    <header class="header">
        <div class="brand">
            <a href="{% url 'restaurants' %}" class="logo-link">
                <img src="{% static 'images/logoo.png' %}" alt="Crave Cart Logo" class="logo">
            </a>
        </div>
        <div class="header-actions">

    <!-- HELP -->
    <a href="{% url 'about' %}" class="icon-btn" title="About Us" aria-label="About Us">
    <span class="icon">‚ÑπÔ∏è</span>
    </a>

    <!-- THEME TOGGLE -->
    <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">
        <span class="icon" id="themeIcon">üåô</span>
    </button>



    <!-- CART (BETWEEN THEME & PROFILE) -->
    {% if request.session.username %}
        <a href="{% url 'view_cart' %}" class="icon-btn cart-btn" title="Cart">
            <span class="cart-icon-box">
                <img
                    id="cartIcon"
                    alt="Cart"
                >
                {% if cart_count and cart_count > 0 %}
                    <span class="cart-count">{{ cart_count }}</span>
                {% endif %}
            </span>
        </a>
    {% endif %}


    <!-- PROFILE -->
    <div class="profile-menu">
        <button class="profile-avatar" onclick="toggleProfileMenu(event)">
            <span class="icon">
                <img
                src="{% if nav_profile.profile_photo %}{{ nav_profile.profile_photo.url }}{% else %}{% static 'images/profile.png' %}{% endif %}"
                alt="Profile"
                class="nav-avatar-img"
                >

            </span>
        </button>

        <!-- DROPDOWN -->
        <div class="profile-dropdown" id="profileDropdown">

            <!-- USER INFO -->
            <div class="profile-header">
                <img
                    src="{% if nav_profile.profile_photo %}{{ nav_profile.profile_photo.url }}{% else %}{% static 'images/profile.png' %}{% endif %}"
                    class="profile-pic"
                    alt="User"
                >
                <div class="profile-meta">
                    <strong class="profile-name">{{ nav_user.username|capfirst }}</strong>
                </div>
                </div>



            <div class="dropdown-divider"></div>

            <!-- MENU -->
                <a href="{% url 'profile'%}" class="dropdown-item">üë§ My Profile</a>
                <a href="{% url 'restaurants' %}" class="dropdown-item">üè† Home</a>
                <a href="{% url 'order_history' %}" class="dropdown-item">üõí Order History</a>

            <div class="dropdown-divider"></div>

            <a href="javascript:void(0)"
                    class="dropdown-item logout"
                    onclick="openLogoutModal()">
                    üö™ Log Out
             </a>

        </div>
    </div>
</div>
    </header>

<div class="profile-page">

  <!-- ================= PROFILE HEADER ================= -->
  <div class="card profile-header">
    <form method="POST" action="{% url 'update_profile_photo' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="avatar-box">
        <img src="{% if profile.profile_photo %}{{ profile.profile_photo.url }}{% else %}{% static 'images/default_user.png' %}{% endif %}">
        <label class="upload-btn">
          Change Photo
          <input type="file" name="profile_photo" hidden onchange="this.form.submit()">
        </label>
      </div>
    </form>

    <div class="profile-info">
      <h2>{{ user.first_name }} {{ user.last_name }}</h2>
      <p class="username">@{{ user.username }}</p>
      <p>{{ user.email }}</p>
      <p><strong>Primary Mobile:</strong> {{ primary_mobile }}</p>
    </div>
  </div>

  <!-- ================= PERSONAL DETAILS ================= -->
  <div class="card">
    <div class="card-header">
      <h3>Personal Details</h3>
      <button type="button" class="btn-outline" onclick="enableProfileEdit()">Edit Profile</button>
    </div>

    <form method="POST" action="{% url 'update_profile' %}" id="profileForm">
      {% csrf_token %}

      <div class="form-grid">

        <div class="full email-edit-box">
          <label>Username</label>
          <div class="email-display">
            <input name="username" id="usernameInput" value="{{ user.username }}" readonly>
            <span class="edit-icon disabled" id="usernamePen" onclick="openUsernamePopup()">‚úèÔ∏è</span>
          </div>
        </div>

        <div>
          <label>First Name</label>
          <input name="first_name" value="{{ user.first_name }}" readonly>
        </div>

        <div>
          <label>Last Name</label>
          <input name="last_name" value="{{ user.last_name }}" readonly>
        </div>

        <div class="full email-edit-box">
          <label>Email</label>
          <div class="email-display">
            <input type="email" name="email" id="emailInput" value="{{ user.email }}" readonly class="readonly">
            <span class="edit-icon disabled" id="emailPen" onclick="openEmailPopup()">‚úèÔ∏è</span>
          </div>
        </div>

        <div>
          <label>Gender</label>
          <input name="gender" value="{{ profile.gender|default:'' }}" readonly>
        </div>

        <div>
          <label>Date of Birth</label>
          <input type="date" name="date_of_birth" value="{{ profile.date_of_birth|date:'Y-m-d' }}" readonly>
        </div>

      </div>

      <button type="submit" class="btn-outline save-btn" style="display:none;">Save Changes</button>
    </form>
  </div>

  <!-- ================= SAVED ADDRESSES ================= -->
  <div class="card">
    <div class="card-header row-between">
      <h3>Saved Addresses</h3>
      <button type="button" class="btn-outline" onclick="openAddressModal()">+ Add New Address</button>
    </div>

    <div class="list-box" id="addressList">
      {% for addr in extra_addresses %}
        <div class="list-item" id="addr-{{ addr.id }}">
          <div class="list-left">
            <div class="list-title">
              <strong>{{ addr.label }}</strong>
              {% if addr.is_default %}
                <span class="badge">Default</span>
              {% endif %}
            </div>
            <div class="list-sub">{{ addr.address }}</div>
          </div>

          <div class="list-actions">
            {% if not addr.is_default %}
              <button class="chip-btn" type="button" onclick="makeDefaultAddress({{ addr.id }})">Make Default</button>
            {% endif %}
            <button class="icon-btn no-circle" type="button" onclick="deleteAddress({{ addr.id }})" title="Delete"><span class="bin-emoji">üóëÔ∏è</span></button>
          </div>
        </div>
      {% empty %}
        <p class="muted" id="addrEmpty">No saved addresses yet.</p>
      {% endfor %}
    </div>
  </div>

  <!-- ================= MOBILE NUMBERS ================= -->
  <div class="card">
    <div class="card-header row-between">
      <h3>Mobile Numbers</h3>
      <button type="button" class="btn-outline" onclick="openMobileModal()">+ Add Mobile Number</button>
    </div>

    <div class="list-box" id="mobileList">
      {% for m in extra_mobiles %}
        <div class="list-item" id="mob-{{ m.id }}">
          <div class="list-left">
            <div class="list-title">
              <strong>{% if m.is_primary %}Primary{% else %}Secondary{% endif %}:</strong>
              <span class="mono">{{ m.mobile }}</span>
              {% if m.is_verified %}
                <span class="status verified">(Verified)</span>
              {% endif %}
            </div>
          </div>

          <div class="list-actions">
            {% if not m.is_primary %}
              <button class="chip-btn" type="button" onclick="makePrimaryMobile({{ m.id }})">Make Primary</button>
            {% endif %}
            <button class="icon-btn no-circle" type="button" onclick="deleteMobile({{ m.id }})"><span class="bin-emoji">üóëÔ∏è</span></button>
          </div>
        </div>
      {% empty %}
        <p class="muted" id="mobEmpty">No extra mobile numbers added.</p>
      {% endfor %}
    </div>
  </div>

  <!-- ================= ADDRESS MODAL ================= -->
  <div id="addressModal" class="popup-overlay" style="display:none;">
    <div class="popup-card">
      <h3>Add Address</h3>

      <form id="addressForm">
        {% csrf_token %}
        <input type="text" name="label" placeholder="Label (Home/Work)" required>
        <textarea name="address" placeholder="Full Address" required
          style="width:100%;margin-top:10px;padding:10px;border:1px solid #ddd;border-radius:10px;"></textarea>

        <div style="display:flex;gap:10px;margin-top:12px;">
          <button type="submit" class="btn-outline">Add</button>
          <button type="button" class="btn-outline" onclick="closeAddressModal()">Cancel</button>
        </div>

        <div id="addressErr" style="color:red;font-size:13px;margin-top:8px;"></div>
      </form>
    </div>
  </div>

  <!-- ================= MOBILE MODAL ================= -->
  <div id="mobileModal" class="popup-overlay" style="display:none;">
    <div class="popup-card">
      <h3>Add Mobile Number</h3>

      <form id="mobileForm">
        {% csrf_token %}
        <input type="text" name="mobile"
               placeholder="Enter 10-digit mobile number"
               inputmode="numeric"
               maxlength="10"
               pattern="^[6-9]\d{9}$"
               title="Enter valid 10-digit Indian mobile number"
               required>

        <div style="display:flex;gap:10px;margin-top:12px;">
          <button type="submit" class="btn-outline">Add</button>
          <button type="button" class="btn-outline" onclick="closeMobileModal()">Cancel</button>
        </div>

        <div id="mobileErr" style="color:red;font-size:13px;margin-top:8px;"></div>
      </form>
    </div>
  </div>

  <!-- FOOTER -->
    <footer class="footer">
        ¬© 2025 CraveCart. All rights reserved.
    </footer>

  <!-- ================= USERNAME PASSWORD POPUP ================= -->
  <div id="usernamePopup" class="popup-overlay" style="display:none;">
    <div class="popup-card">
      <h3>Verify Password</h3>

      <form id="usernameVerifyForm">
        {% csrf_token %}
        <input type="password" name="password" placeholder="Enter current password" required>
        <div id="usernameVerifyError" style="color:red;font-size:13px;margin-top:8px;"></div>

        <button type="submit" class="btn-outline">Verify</button>
        <button type="button" class="btn-outline" onclick="closeUsernamePopup()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- ================= EMAIL PASSWORD POPUP ================= -->
  <div id="emailPopup" class="popup-overlay" style="display:none;">
    <div class="popup-card">
      <h3>Verify Password</h3>

      <form id="emailVerifyForm">
        {% csrf_token %}
        <input type="password" name="password" placeholder="Enter current password" required>
        <div id="emailVerifyError" style="color:red;font-size:13px;margin-top:8px;"></div>

        <button type="submit" class="btn-outline">Verify</button>
        <button type="button" class="btn-outline" onclick="closeEmailPopup()">Cancel</button>
      </form>
    </div>
  </div>

</div><!-- ‚úÖ end profile-page -->


<!-- ================= CONFIRM POPUP (reusable) ================= -->
<div id="confirmPopup" class="popup-overlay" style="display:none;" onclick="confirmOverlayClick(event)">
  <div class="popup-card confirm-card">
    <h3 id="confirmTitle" class="confirm-title">Confirm</h3>
    <p id="confirmMessage" class="confirm-msg"></p>

    <div class="confirm-actions">
      <button type="button" class="btn-outline" id="confirmOkBtn">OK</button>
      <button type="button" class="btn-outline" onclick="closeConfirmPopup()">Cancel</button>
    </div>
  </div>
</div>

<!-- LOGOUT MODAL -->
<div class="logout-overlay" id="logoutOverlay">
    <div class="logout-modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>

        <button class="btn primary full-width" onclick="confirmLogout()">
            Yes, Log Me Out
        </button>
    </div>
</div>

<script src="{% static 'js/theme.js' %}"></script>
<script>
let editMode = false;

const CART_LIGHT = "{% static 'images/dark-cart.png' %}";
const CART_DARK  = "{% static 'images/light-cart.png' %}";

function toggleProfileMenu(event) {
    event.stopPropagation();
    document.getElementById("profileDropdown").classList.toggle("show");
}

document.addEventListener("click", function () {
    const dropdown = document.getElementById("profileDropdown");
    if (dropdown) dropdown.classList.remove("show");
});

function openLogoutModal() {
    document.getElementById("logoutOverlay").classList.add("show");
}

function confirmLogout() {
    window.location.href = "{% url 'logout' %}";
}

/* ‚úÖ safer: fetch csrf from any available csrf input on page */
function getCSRFTokenFromAnyForm() {
  const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
  return input ? input.value : "";
}

/* ‚úÖ Use this for all ajax calls */
function csrfFD() {
  const fd = new FormData();
  fd.append("csrfmiddlewaretoken", getCSRFTokenFromAnyForm());
  return fd;
}

/* ========== Personal edit ========== */
function enableProfileEdit() {
  editMode = true;

  const form = document.getElementById("profileForm");
  form.querySelectorAll("input").forEach(i => {
    if (!i.classList.contains("readonly") && i.name !== "username") {
      i.removeAttribute("readonly");
    }
  });

  document.querySelector(".save-btn").style.display = "inline-block";
  document.getElementById("usernamePen").classList.remove("disabled");
  document.getElementById("emailPen").classList.remove("disabled");
}

/* ========== Username / Email popups ========== */
function openUsernamePopup() {
  if (!editMode) return;
  document.getElementById("usernamePopup").style.display = "flex";
}
function closeUsernamePopup() {
  document.getElementById("usernamePopup").style.display = "none";
}
function openEmailPopup() {
  if (!editMode) return;
  document.getElementById("emailPopup").style.display = "flex";
}
function closeEmailPopup() {
  document.getElementById("emailPopup").style.display = "none";
}

/* Username verify */
document.getElementById("usernameVerifyForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const errorBox = document.getElementById("usernameVerifyError");
  errorBox.textContent = "";

  const res = await fetch("{% url 'verify_username_password' %}", {
    method: "POST",
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if (data.success) {
    closeUsernamePopup();
    const usernameInput = document.getElementById("usernameInput");
    usernameInput.removeAttribute("readonly");
    usernameInput.focus();
  } else {
    errorBox.textContent = data.message || "Verification failed";
  }
});

/* Email verify */
document.getElementById("emailVerifyForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const formData = new FormData(this);
  const errorBox = document.getElementById("emailVerifyError");
  errorBox.textContent = "";

  const res = await fetch("{% url 'verify_email_password' %}", {
    method: "POST",
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if (data.success) {
    closeEmailPopup();
    const emailInput = document.getElementById("emailInput");
    emailInput.removeAttribute("readonly");
    emailInput.classList.remove("readonly");
    emailInput.focus();
  } else {
    errorBox.textContent = data.message || "Verification failed";
  }
});

/* ========== Helpers ========== */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ‚úÖ 10-digit validation */
function isValid10DigitMobile(m){
  return /^[6-9]\d{9}$/.test((m || "").trim());
}

/* ========== Modals ========== */
function openAddressModal(){ document.getElementById("addressModal").style.display="flex"; }
function closeAddressModal(){ document.getElementById("addressModal").style.display="none"; }
function openMobileModal(){ document.getElementById("mobileModal").style.display="flex"; }
function closeMobileModal(){ document.getElementById("mobileModal").style.display="none"; }

/* ========== Confirm popup ========== */
let _confirmAction = null;

function openConfirmPopup(message, onOk, title="Confirm") {
  document.getElementById("confirmTitle").textContent = title;
  document.getElementById("confirmMessage").textContent = message;

  _confirmAction = onOk;

  const okBtn = document.getElementById("confirmOkBtn");
  okBtn.onclick = async () => {
    try { if (_confirmAction) await _confirmAction(); }
    finally { closeConfirmPopup(); }
  };

  document.getElementById("confirmPopup").style.display = "flex";
}

function closeConfirmPopup() {
  document.getElementById("confirmPopup").style.display = "none";
  _confirmAction = null;
}

function confirmOverlayClick(e){
  if(e.target.id === "confirmPopup") closeConfirmPopup();
}

document.addEventListener("keydown", (e) => {
  if(e.key === "Escape"){
    const p = document.getElementById("confirmPopup");
    if(p && p.style.display === "flex") closeConfirmPopup();
  }
});

/* ========== Address add/delete ========== */
document.getElementById("addressForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const err = document.getElementById("addressErr");
  err.textContent = "";

  const res = await fetch("{% url 'add_extra_address' %}", {
    method: "POST",
    body: new FormData(form),
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if (!res.ok || data.error) {
    err.textContent = data.error || "Failed to add address";
    return;
  }

  document.getElementById("addrEmpty")?.remove();

  document.getElementById("addressList").insertAdjacentHTML("afterbegin", `
    <div class="list-item" id="addr-${data.id}">
      <div class="list-left">
        <div class="list-title">
          <span class="icon">üè†</span>
          <strong>${escapeHtml(data.label || "Address")}</strong>
        </div>
        <div class="list-sub">${escapeHtml(data.address || "")}</div>
      </div>
      <div class="list-actions">
        <button class="icon-btn danger" type="button" onclick="deleteAddress(${data.id})" title="Delete">üóëÔ∏è</button>
      </div>
    </div>
  `);

  form.reset();
  closeAddressModal();
});

window.deleteAddress = function(id){
  openConfirmPopup("Delete this address?", async () => {
    const fd = csrfFD();

    const res = await fetch("{% url 'delete_extra_address' 0 %}".replace("0", id), {
      method: "POST",
      body: fd,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const data = await res.json();
    if(data.success){
      document.getElementById(`addr-${id}`)?.remove();

      const list = document.getElementById("addressList");
      if(list && list.querySelectorAll(".list-item").length === 0){
        list.innerHTML = `<p class="muted" id="addrEmpty">No saved addresses yet.</p>`;
      }
    }
  }, "Delete Address");
}

/* ========== Mobile add/delete ========== */
document.getElementById("mobileForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.target;
  const err = document.getElementById("mobileErr");
  err.textContent = "";

  const mobileInput = form.querySelector('input[name="mobile"]');
  const mobileValue = (mobileInput.value || "").trim();

  if(!isValid10DigitMobile(mobileValue)){
    err.textContent = "Enter a valid 10-digit mobile number (starts with 6-9).";
    mobileInput.focus();
    return;
  }

  const res = await fetch("{% url 'add_extra_mobile' %}", {
    method: "POST",
    body: new FormData(form),
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if (!res.ok || data.error) {
    err.textContent = data.error || "Failed to add mobile";
    return;
  }

  document.getElementById("mobEmpty")?.remove();

  document.getElementById("mobileList").insertAdjacentHTML("afterbegin", `
    <div class="list-item" id="mob-${data.id}">
      <div class="list-left">
        <div class="list-title">
          <strong>${data.is_primary ? "Primary" : "Secondary"}:</strong>
          <span class="mono">${escapeHtml(data.mobile || "")}</span>
        </div>
      </div>
      <div class="list-actions">
        ${data.is_primary ? "" : `<button class="chip-btn" type="button" onclick="makePrimaryMobile(${data.id})">Make Primary</button>`}
        <button class="chip-btn danger" type="button" onclick="deleteMobile(${data.id})">üóëÔ∏è</button>
      </div>
    </div>
  `);

  form.reset();
  closeMobileModal();
});

window.deleteMobile = function(id){
  openConfirmPopup("Delete this mobile number?", async () => {
    const fd = csrfFD();

    const res = await fetch("{% url 'delete_extra_mobile' 0 %}".replace("0", id), {
      method: "POST",
      body: fd,
      headers: { "X-Requested-With": "XMLHttpRequest" }
    });

    const data = await res.json();
    if(data.success){
      document.getElementById(`mob-${id}`)?.remove();

      const list = document.getElementById("mobileList");
      if(list && list.querySelectorAll(".list-item").length === 0){
        list.innerHTML = `<p class="muted" id="mobEmpty">No extra mobile numbers added.</p>`;
      }
    }
  }, "Delete Mobile");
}

/* ========== Make primary / default ========== */
async function makePrimaryMobile(id){
  const fd = csrfFD();

  const res = await fetch("{% url 'make_primary_mobile' 0 %}".replace("0", id), {
    method: "POST",
    body: fd,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if(data.success) location.reload();
}

async function makeDefaultAddress(id){
  const fd = csrfFD();

  const res = await fetch("{% url 'make_default_address' 0 %}".replace("0", id), {
    method: "POST",
    body: fd,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  });

  const data = await res.json();
  if(data.success) location.reload();
}
</script>

</body>
</html>
