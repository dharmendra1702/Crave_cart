{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order History | Crave Cart</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{% static 'css/custom_show_style.css' %}">
<link rel="stylesheet" href="{% static 'css/order_history.css' %}">

</head>

<body>

    <!-- HEADER -->
    <header class="header">
        <div class="brand">
            <a href="{% url 'home' %}" class="logo-link">
                <img src="{% static 'images/logoo.png' %}" alt="Crave Cart Logo" class="logo">
            </a>
        </div>

        <!-- RIGHT ACTIONS -->
        <div class="header-actions">

            <!-- HELP -->
            <button class="icon-btn" title="Help">
                <span class="icon">‚ùì</span>
            </button>

            <!-- THEME TOGGLE -->
        <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">
            <span id="themeIcon", class = "icon">üåô</span>
        </button>


    <!-- CART (BETWEEN THEME & PROFILE) -->
    {% if request.session.username %}
        <a href="{% url 'view_cart' %}" class="icon-btn cart-btn" title="Cart">
            <span class="cart-icon-box">
                <img
                    id="cartIcon"
                    alt="Cart"
                >
                {% if cart_count and cart_count > 0 %}
                    <span class="cart-count">{{ cart_count }}</span>
                {% endif %}
            </span>
        </a>
    {% endif %}



            <!-- PROFILE -->
            <div class="profile-menu">
                <button class="profile-avatar" onclick="toggleProfileMenu(event)">
                    <span class="icon">
                    <img src="{% static 'images/profile.png' %}" alt="Profile">
                    </span>
                </button>

                <!-- DROPDOWN -->
                <div class="profile-dropdown" id="profileDropdown">

                    <!-- USER INFO -->
                    <div class="profile-header">
                        <img src="{% static 'images/profile.png' %}" class="profile-pic">
                        <div>
                            <strong>{{ username|capfirst }}</strong>
                        </div>
                    </div>

                    <div class="dropdown-divider"></div>

                    <!-- CUSTOMER MENU -->
                    <a href="#" class="dropdown-item">üë§ My Profile</a>
                    <a href="{% url 'order_history' %}" class="dropdown-item">üõí Order History</a>

                    <div class="dropdown-divider"></div>

                    <a href="javascript:void(0)"
                        class="dropdown-item logout"
                        onclick="openLogoutModal()">
                            üö™ Log Out
                    </a>


                </div>
            </div>
        </div>
    </header>

<div class="orders-wrapper">
    <h2 style="text-align:center;font-size:32px;margin-bottom:26px;">
        Your Orders
    </h2>

  {% for order in orders %}

<div class="order-card">

  <!-- ORDER HEADER -->
  <div class="order-header">
    <div>
      <div class="order-id">Order #{{ order.order_number }}</div>
      <div class="order-date">
        {{ order.created_at|date:"d M Y, h:i A" }}
      </div>
    </div>
    <span class="order-status {{ order.status }}">
      {{ order.get_status_display }}
    </span>
  </div>

  <!-- ITEMS -->
  <div class="order-items-box">
    {% with order.items.all as items %}
      <div class="order-item">
        <img src="{{ items.0.item_image|default:'/static/images/default-food.png' }}">
        <div>
          <strong>{{ items.0.item_name }}</strong>
          <div>Qty {{ items.0.quantity }} √ó ‚Çπ{{ items.0.price }}</div>
        </div>
      </div>

        <div class="extra-items" id="items-{{ order.id }}">
          {% for item in items|slice:"1:" %}
            <div class="order-item">
              <img src="{{ item.item_image }}">
              <div>
                <strong>{{ item.item_name }}</strong>
                <div>Qty {{ item.quantity }} √ó ‚Çπ{{ item.price }}</div>
              </div>
            </div>
          {% endfor %}
        </div>


        {% if items|length > 1 %}
          <button
            class="more-items-btn"
            id="btn-{{ order.id }}"
            data-count="{{ items|length|add:'-1' }}"
            onclick="toggleItems({{ order.id }})">
            +{{ items|length|add:"-1" }} more items
          </button>
        {% endif %}

    {% endwith %}
  </div>

  <!-- PRICE -->
  <div class="price-breakdown">
    <div class="row"><span>Item total</span><span>‚Çπ{{ order.subtotal }}</span></div>
    <div class="row"><span>GST (5%)</span><span>‚Çπ{{ order.gst_amount }}</span></div>
    <div class="row"><span>Delivery fee</span><span>‚Çπ{{ order.delivery_fee }}</span></div>
    <div class="row"><span>Coupon Discount</span><span>-‚Çπ{{ order.coupon_discount|default:"0.0" }}</span></div>
    <div class="row total"><span>Total paid</span><span>‚Çπ{{ order.total_amount }}</span></div>
  </div>

  <!-- TRACK -->
  <button class="track-btn" onclick="toggleTrack({{ order.id }})">
    üöö Track Order
  </button>

  <div class="track-panel" id="track-{{ order.id }}">
    <div class="track-steps">
      <div class="step active">Placed</div>
      <div class="step {% if order.status != 'PLACED' %}active{% endif %}">Preparing</div>
      <div class="step {% if order.status in 'OUT_FOR_DELIVERY DELIVERED' %}active{% endif %}">On the way</div>
      <div class="step {% if order.status == 'DELIVERED' %}active{% endif %}">Delivered</div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="order-footer">
    {% if order.status == "DELIVERED" %}
      <div class="eta delivered">
        ‚úÖ Delivered in {{ order.delivery_minutes }} minutes
      </div>
    {% else %}
      <div class="eta">‚è± Estimated delivery: <b>30‚Äì40 mins</b></div>
    {% endif %}

    <div class="footer-right">
      <a href="{% url 'download_invoice' order.id %}">Invoice</a>
      <a href="{% url 'reorder' order.id %}">Reorder</a>
    </div>
  </div>

  <!-- ‚≠ê RATING (ONLY IF DELIVERED & NOT RATED) -->
  {% if order.status == "DELIVERED" and not order.rating %}
  <div class="rating-box">
    <form method="post" action="{% url 'rate_order' order.id %}">
      {% csrf_token %}
      <div class="stars">
        {% for i in "54321" %}
          <input type="radio" id="star{{ i }}-{{ order.id }}" name="rating" value="{{ i }}" required>
          <label for="star{{ i }}-{{ order.id }}">‚òÖ</label>
        {% endfor %}
      </div>
      <textarea name="review" placeholder="Write a review (optional)‚Ä¶"></textarea>
      <button class="rate-btn">Submit Review</button>
    </form>
  </div>
  {% endif %}

  <!-- ‚≠ê ALREADY RATED -->
  {% if order.rating %}
  <div class="rated-box">
    ‚≠ê Rated: {{ order.rating }}/5 <br>
    <em>{{ order.review }}</em>
  </div>
  {% endif %}

  <script>
    startLiveTracking({{ order.id }});
  </script>

</div>

{% endfor %}

</div>

<!-- FOOTER -->
    <footer class="footer">
        ¬© 2025 Crave Cart
    </footer>

</div>
<!-- LOGOUT MODAL -->
<div class="logout-overlay" id="logoutOverlay">
    <div class="logout-modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>

        <button class="btn primary full-width" onclick="confirmLogout()">
            Yes, Log Me Out
        </button>
    </div>
</div>

<script src="{% static 'js/theme.js' %}"></script>
<script>
const CART_LIGHT = "{% static 'images/dark-cart.png' %}";
const CART_DARK  = "{% static 'images/light-cart.png' %}";

function toggleProfileMenu(event) {
    event.stopPropagation();
    document.getElementById("profileDropdown").classList.toggle("show");
}

document.addEventListener("click", function () {
    const dropdown = document.getElementById("profileDropdown");
    if (dropdown) dropdown.classList.remove("show");
});

function openLogoutModal() {
    document.getElementById("logoutOverlay").classList.add("show");
}

function confirmLogout() {
    window.location.href = "{% url 'logout' %}";
}

function addItem(btn) {
    const wrapper = btn.parentElement;
    btn.classList.add("hidden");
    wrapper.querySelector(".qty-box").classList.remove("hidden");
}



function addItem(btn, qty = 1) {
    const wrapper = btn.closest(".qty-wrapper");
    btn.classList.add("hidden");
    const box = wrapper.querySelector(".qty-box");
    box.classList.remove("hidden");
    box.querySelector(".qty-count").textContent = qty;
}

function toggleTrack(id) {
  const panel = document.getElementById("track-" + id);
  document.querySelectorAll(".track-panel").forEach(p => {
    if (p !== panel) p.style.display = "none";
  });
  panel.style.display = panel.style.display === "block" ? "none" : "block";
}

/* ---------- TRACK TOGGLE (SMOOTH) ---------- */
function toggleTrack(orderId) {
  const panel = document.getElementById("track-" + orderId);

  document.querySelectorAll(".track-panel").forEach(p => {
    if (p !== panel) p.classList.remove("open");
  });

  panel.classList.toggle("open");
}


/* ---------- LIVE ORDER STATUS ---------- */
function startLiveTracking(orderId) {
  setInterval(() => {
    fetch(`/order-status/${orderId}/`)
      .then(res => res.json())
      .then(data => {
        const badge = document.querySelector(`.order-status.${orderId}`);
        if (!badge) return;

        badge.textContent = data.status_display;
        badge.className = `order-status ${data.status}`;
        updateSteps(orderId, data.status);
      });
  }, 5000);
}

/* ---------- TRACK STEPS ---------- */
function updateSteps(orderId, status) {
  const steps = document.querySelectorAll(`#track-${orderId} .step`);
  const flow = ["PLACED", "PREPARING", "OUT_FOR_DELIVERY", "DELIVERED"];

  steps.forEach((step, i) => {
    step.classList.toggle("active", flow.indexOf(status) >= i);
  });
}

function toggleItems(orderId) {
  const items = document.getElementById("items-" + orderId);
  const btn = document.getElementById("btn-" + orderId);

  if (!items || !btn) return;

  const count = btn.dataset.count;
  const isOpen = items.classList.toggle("open");

  btn.textContent = isOpen
    ? "Show less"
    : `+${count} more items`;
}
</script>

</body>
</html>
