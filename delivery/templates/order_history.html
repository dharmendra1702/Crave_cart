{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Order History | Crave Cart</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{% static 'css/custom_show_style.css' %}">
<link rel="stylesheet" href="{% static 'css/history.css' %}">



</head>

<body>

    <!-- HEADER -->
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <a href="{% url 'restaurants' %}" class="logo-link">
                <img src="{% static 'images/logoo.png' %}" alt="Crave Cart Logo" class="logo">
            </a>
        </div>
        <div class="header-actions">

    <!-- HELP -->
    <a href="{% url 'about' %}" class="icon-btn" title="About Us" aria-label="About Us">
    <span class="icon">â„¹ï¸</span>
    </a>

    <!-- THEME TOGGLE -->
    <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">
        <span class="icon" id="themeIcon">ğŸŒ™</span>
    </button>



    <!-- CART (BETWEEN THEME & PROFILE) -->
    {% if request.session.username %}
        <a href="{% url 'view_cart' %}" class="icon-btn cart-btn" title="Cart">
            <span class="cart-icon-box">
                <img
                    id="cartIcon"
                    alt="Cart"
                >
                {% if cart_count and cart_count > 0 %}
                    <span class="cart-count">{{ cart_count }}</span>
                {% endif %}
            </span>
        </a>
    {% endif %}


    <!-- PROFILE -->
    <div class="profile-menu">
        <button class="profile-avatar" onclick="toggleProfileMenu(event)">
            <span class="icon">
                <img
                src="{% if nav_profile.profile_photo %}{{ nav_profile.profile_photo.url }}{% else %}{% static 'images/profile.png' %}{% endif %}"
                alt="Profile"
                class="nav-avatar-img"
                >

            </span>
        </button>

        <!-- DROPDOWN -->
        <div class="profile-dropdown" id="profileDropdown">

            <!-- USER INFO -->
            <div class="profile-header">
                <img
                    src="{% if nav_profile.profile_photo %}{{ nav_profile.profile_photo.url }}{% else %}{% static 'images/profile.png' %}{% endif %}"
                    class="profile-pic"
                    alt="User"
                >
                <div class="profile-meta">
                    <strong class="profile-name">{{ nav_user.username|capfirst }}</strong>
                </div>
                </div>



            <div class="dropdown-divider"></div>

            <!-- MENU -->
                <a href="{% url 'profile'%}" class="dropdown-item">ğŸ‘¤ My Profile</a>
                <a href="{% url 'restaurants' %}" class="dropdown-item">ğŸ  Home</a>
                <a href="{% url 'order_history' %}" class="dropdown-item">ğŸ›’ Order History</a>

            <div class="dropdown-divider"></div>

            <a href="javascript:void(0)"
                    class="dropdown-item logout"
                    onclick="openLogoutModal()">
                    ğŸšª Log Out
             </a>

        </div>
    </div>
</div>
    </header>

<div class="orders-wrapper">
    <h2 style="text-align:center;font-size:32px;margin-bottom:26px;">
        Your Orders
    </h2>

  {% for order in orders %}

<div class="order-card">

  <!-- ORDER HEADER -->
  <div class="order-header">
    <div>
      <div class="order-id">Order #{{ order.order_number }}</div>
      <div class="order-date">
        {{ order.created_at|date:"d M Y, h:i A" }}
      </div>
    </div>
    <span class="order-status {{ order.status }}">
      {{ order.get_status_display }}
    </span>
  </div>

  <!-- ITEMS -->
  <div class="order-items-box">
    {% with order.items.all as items %}
      <div class="order-item">
        <img src="{{ items.0.item_image|default:'/static/images/default-food.png' }}">
        <div>
          <strong>{{ items.0.item_name }}</strong>
          <div>Qty {{ items.0.quantity }} Ã— â‚¹{{ items.0.price }}</div>
        </div>
      </div>

        <div class="extra-items" id="items-{{ order.id }}">
          {% for item in items|slice:"1:" %}
            <div class="order-item">
              <img src="{{ item.item_image }}">
              <div>
                <strong>{{ item.item_name }}</strong>
                <div>Qty {{ item.quantity }} Ã— â‚¹{{ item.price }}</div>
              </div>
            </div>
          {% endfor %}
        </div>


        {% if items|length > 1 %}
          <button
            class="more-items-btn"
            id="btn-{{ order.id }}"
            data-count="{{ items|length|add:'-1' }}"
            onclick="toggleItems({{ order.id }})">
            +{{ items|length|add:"-1" }} more items
          </button>
        {% endif %}

    {% endwith %}
  </div>

  <!-- PRICE -->
  <div class="price-breakdown">
    <div class="row"><span>Item total</span><span>â‚¹{{ order.subtotal }}</span></div>
    <div class="row"><span>GST (5%)</span><span>â‚¹{{ order.gst_amount }}</span></div>
    <div class="row"><span>Delivery fee</span><span>â‚¹{{ order.delivery_fee }}</span></div>
    <div class="row"><span>Coupon Discount</span><span>-â‚¹{{ order.coupon_discount|default:"0.0" }}</span></div>
    <div class="row total"><span>Total paid</span><span>â‚¹{{ order.total_amount }}</span></div>
  </div>

  <div class="order-row">
    <strong>Address:</strong>
    {{ order.delivery_address_label|default:"" }}
    {% if order.delivery_address %} - {{ order.delivery_address }}{% endif %}
  </div>

  <div class="order-row">
    <strong>Payment:</strong> {{ order.payment_method }} â€¢ {{ order.payment_status }}
  </div>

  <!-- TRACK -->
  <button class="track-btn" onclick="toggleTrack({{ order.id }})">
    ğŸšš Track Order
  </button>

<div class="track-panel" id="track-{{ order.id }}">
  <div class="track-steps">
    {% if order.status == "CANCELLED" %}
      <div class="step cancelled active">Cancelled</div>
    {% else %}
      <div class="step {% if order.status in "PLACED PREPARING OUT_FOR_DELIVERY DELIVERED" %}active{% endif %}">Placed</div>
      <div class="step {% if order.status in "PREPARING OUT_FOR_DELIVERY DELIVERED" %}active{% endif %}">Preparing</div>
      <div class="step {% if order.status in "OUT_FOR_DELIVERY DELIVERED" %}active{% endif %}">On the way</div>
      <div class="step {% if order.status == "DELIVERED" %}active{% endif %}">Delivered</div>
    {% endif %}
  </div>
</div>


  <!-- FOOTER -->
  <div class="order-footer">

  {% if order.status == "CANCELLED" %}
  <div class="eta delivered" style="color:#e53935;">
    Order Cancelled
  </div>
{% elif order.status == "DELIVERED" %}
  <div class="eta delivered">
    âœ… Delivered in {{ order.delivery_minutes }} minutes
    {% if order.delivered_at %}
      <span class="delivered-date">
        {{ order.delivered_at|date:"d M Y, h:i A" }}
      </span>
    {% endif %}
  </div>
{% else %}
  <div class="eta">â± Estimated delivery: <b>30â€“40 mins</b></div>
{% endif %}


  <div class="footer-right">

    {# âœ… Cancel allowed only BEFORE OUT_FOR_DELIVERY #}
    {% if order.status == "PLACED" or order.status == "PREPARING" %}
  <button type="button"
          class="cancel-btn"
          onclick="openCancelModal('{{ order.id }}','{{ order.order_number }}')">
    Cancel Order
  </button>
{% endif %}


    <a href="{% url 'download_invoice' order.id %}">Invoice</a>
    <a href="{% url 'reorder' order.id %}">Reorder</a>
  </div>

</div>


  <!-- â­ RATING (ONLY IF DELIVERED & NOT RATED) -->
  {% if order.status == "DELIVERED" and not order.rating %}
<div class="rating-box">
  <form method="post" action="{% url 'rate_order' order.id %}">
    {% csrf_token %}

    <!-- âœ… PUT SLIDER HERE (replace stars block) -->
    <div class="rating-stars-wrap" data-order="{{ order.id }}">
  <!-- hidden real input that will be submitted -->
  <input
    type="range"
    id="ratingInput-{{ order.id }}"
    name="rating"
    min="0"
    max="5"
    step="0.1"
    value="4.5"
    class="rating-hidden-range"
  />

  <!-- star UI -->
  <div
    class="stars-10"
    id="stars-{{ order.id }}"
    role="slider"
    aria-label="Rating"
    aria-valuemin="0"
    aria-valuemax="5"
    aria-valuenow="4.5"
    tabindex="0"
    data-target="ratingInput-{{ order.id }}"
  >
    <div class="stars-base" aria-hidden="true"><span class="stars-text">â˜…â˜…â˜…â˜…â˜…</span></div>
    <div class="stars-fill" aria-hidden="true"><span class="stars-text">â˜…â˜…â˜…â˜…â˜…</span></div>
  </div>

  <span class="rating-value"><b id="rv-{{ order.id }}">4.5</b>/5</span>
</div>


    <textarea name="review" placeholder="Write a review (optional)â€¦"></textarea>
    <button class="rate-btn">Submit Review</button>
  </form>
</div>
{% endif %}


  <!-- â­ ALREADY RATED -->
 {% if order.rating %}
  <div class="rated-pill">
    <span class="rated-value">{{ order.rating|floatformat:1 }}</span>

    <span class="rated-stars-precise" aria-label="Rated {{ order.rating|floatformat:1 }} out of 5">
      <span class="stars-base" aria-hidden="true">â˜…â˜…â˜…â˜…â˜…</span>
      <span class="stars-fill" aria-hidden="true"
            style="width: calc({{ order.rating|floatformat:1 }} * 20%);">â˜…â˜…â˜…â˜…â˜…</span>
    </span>
  </div>

  {% if order.review %}
    <div class="review-text"><em>{{ order.review }}</em></div>
  {% endif %}
{% endif %}



  <script>
    startLiveTracking({{ order.id }});
  </script>

</div>

{% endfor %}

</div>

<!-- FOOTER -->
    <footer class="footer">
        Â© 2025 CraveCart. All rights reserved.
    </footer>

</div>
<!-- LOGOUT MODAL -->
<div class="logout-overlay" id="logoutOverlay">
    <div class="logout-modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>

        <button class="btn primary full-width" onclick="confirmLogout()">
            Yes, Log Me Out
        </button>
    </div>
</div>

<div class="logout-overlay" id="cancelOverlay">
  <div class="logout-modal">
    <h3 id="cancelTitle">Cancel Order?</h3>
    <p>This action cannot be undone.</p>

    <form id="cancelForm" method="post">
      {% csrf_token %}
      <button type="submit" class="btn primary full-width">
        Yes, Cancel Order
      </button>
    </form>

    <button type="button" class="btn full-width" style="margin-top:10px;" onclick="closeCancelModal()">
      No, Keep Order
    </button>
  </div>
</div>


<script src="{% static 'js/theme.js' %}"></script>
<script>
const CART_LIGHT = "{% static 'images/dark-cart.png' %}";
const CART_DARK  = "{% static 'images/light-cart.png' %}";

function toggleProfileMenu(event) {
    event.stopPropagation();
    document.getElementById("profileDropdown").classList.toggle("show");
}

document.addEventListener("click", function () {
    const dropdown = document.getElementById("profileDropdown");
    if (dropdown) dropdown.classList.remove("show");
});

function openLogoutModal() {
    document.getElementById("logoutOverlay").classList.add("show");
}

function confirmLogout() {
    window.location.href = "{% url 'logout' %}";
}

function addItem(btn) {
    const wrapper = btn.parentElement;
    btn.classList.add("hidden");
    wrapper.querySelector(".qty-box").classList.remove("hidden");
}



function addItem(btn, qty = 1) {
    const wrapper = btn.closest(".qty-wrapper");
    btn.classList.add("hidden");
    const box = wrapper.querySelector(".qty-box");
    box.classList.remove("hidden");
    box.querySelector(".qty-count").textContent = qty;
}

function toggleTrack(id) {
  const panel = document.getElementById("track-" + id);
  document.querySelectorAll(".track-panel").forEach(p => {
    if (p !== panel) p.style.display = "none";
  });
  panel.style.display = panel.style.display === "block" ? "none" : "block";
}

/* ---------- TRACK TOGGLE (SMOOTH) ---------- */
function toggleTrack(orderId) {
  const panel = document.getElementById("track-" + orderId);

  document.querySelectorAll(".track-panel").forEach(p => {
    if (p !== panel) p.classList.remove("open");
  });

  panel.classList.toggle("open");
}


/* ---------- LIVE ORDER STATUS ---------- */
function startLiveTracking(orderId) {
  setInterval(() => {
    fetch(`/order-status/${orderId}/`)
      .then(res => res.json())
      .then(data => {
        const badge = document.querySelector(`.order-status.${orderId}`);
        if (!badge) return;

        badge.textContent = data.status_display;
        badge.className = `order-status ${data.status}`;
        updateSteps(orderId, data.status);
      });
  }, 5000);
}

/* ---------- TRACK STEPS ---------- */
function updateSteps(orderId, status) {
  const panel = document.querySelector(`#track-${orderId} .track-steps`);
  if (!panel) return;

  if (status === "CANCELLED") {
    panel.innerHTML = `<div class="step cancelled active">Cancelled</div>`;
    return;
  }

  const steps = document.querySelectorAll(`#track-${orderId} .step`);
  const flow = ["PLACED", "PREPARING", "OUT_FOR_DELIVERY", "DELIVERED"];

  steps.forEach((step, i) => {
    step.classList.toggle("active", flow.indexOf(status) >= i);
  });
}


function toggleItems(orderId) {
  const items = document.getElementById("items-" + orderId);
  const btn = document.getElementById("btn-" + orderId);

  if (!items || !btn) return;

  const count = btn.dataset.count;
  const isOpen = items.classList.toggle("open");

  btn.textContent = isOpen
    ? "Show less"
    : `+${count} more items`;
}

function openCancelModal(orderId, orderNumber) {
  const overlay = document.getElementById("cancelOverlay");
  const form = document.getElementById("cancelForm");
  const title = document.getElementById("cancelTitle");

  // show order number in popup
  title.textContent = `Cancel Order #${orderNumber}?`;

  // IMPORTANT: match your urls.py path
  form.action = `/order/${orderId}/cancel/`;

  overlay.classList.add("show");
}

function closeCancelModal() {
  document.getElementById("cancelOverlay").classList.remove("show");
}

// close on outside click (same feel as logout)
document.addEventListener("click", function (e) {
  const overlay = document.getElementById("cancelOverlay");
  if (e.target === overlay) closeCancelModal();
});

function clamp(n, min, max){ return Math.min(max, Math.max(min, n)); }

function setStars(el, value){
  const fill = el.querySelector(".stars-fill");
  const v = clamp(Math.round(value * 10) / 10, 0, 5); // 0.1 steps
  const pct = (v / 5) * 100;

  fill.style.width = pct + "%";

  const inputId = el.dataset.target;
  const input = document.getElementById(inputId);
  if (input) input.value = v.toFixed(1);

  const orderId = el.id.split("stars-")[1];
  const rv = document.getElementById("rv-" + orderId);
  if (rv) rv.textContent = v.toFixed(1);

  el.setAttribute("aria-valuenow", v.toFixed(1));
}

function valueFromPointer(el, clientX){
  const rect = el.getBoundingClientRect();
  const x = clamp(clientX - rect.left, 0, rect.width);
  const raw = (x / rect.width) * 5;          // 0..5
  return Math.round(raw * 10) / 10;          // 0.1
}

function initStarRatings(){
  document.querySelectorAll(".stars-10").forEach(el => {
    // initial render from hidden input value
    const input = document.getElementById(el.dataset.target);
    const startVal = input ? parseFloat(input.value || "0") : 0;
    setStars(el, startVal);

    let dragging = false;

    const onMove = (e) => {
      if (!dragging) return;
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      setStars(el, valueFromPointer(el, x));
    };

    const onUp = () => { dragging = false; };

    el.addEventListener("mousedown", (e) => {
      dragging = true;
      setStars(el, valueFromPointer(el, e.clientX));
    });
    window.addEventListener("mousemove", onMove);
    window.addEventListener("mouseup", onUp);

    el.addEventListener("touchstart", (e) => {
      dragging = true;
      setStars(el, valueFromPointer(el, e.touches[0].clientX));
    }, {passive:true});
    window.addEventListener("touchmove", onMove, {passive:true});
    window.addEventListener("touchend", onUp);

    // click (also works without drag)
    el.addEventListener("click", (e) => {
      setStars(el, valueFromPointer(el, e.clientX));
    });

    // keyboard (0.1 steps)
    el.addEventListener("keydown", (e) => {
      const input = document.getElementById(el.dataset.target);
      const cur = input ? parseFloat(input.value || "0") : 0;
      if (e.key === "ArrowRight" || e.key === "ArrowUp") {
        e.preventDefault();
        setStars(el, cur + 0.1);
      } else if (e.key === "ArrowLeft" || e.key === "ArrowDown") {
        e.preventDefault();
        setStars(el, cur - 0.1);
      } else if (e.key === "Home") {
        e.preventDefault();
        setStars(el, 0);
      } else if (e.key === "End") {
        e.preventDefault();
        setStars(el, 5);
      }
    });
  });
}

document.addEventListener("DOMContentLoaded", initStarRatings);
</script>

</body>
</html>
