{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout | Crave Cart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/custom_show_style.css' %}">


    <style>
/* ================= ROOT ================= */
:root {
    --primary: #22c55e;
    --primary-dark: #16a34a;
    --bg-light: #f8fafc;
    --bg-card: rgba(255,255,255,0.9);
    --text-main: #0f172a;
    --text-muted: #64748b;
    --border-soft: rgba(0,0,0,0.08);
}

body[data-theme="dark"] {
    --bg-light: #0f172a;
    --bg-card: rgba(20,20,20,0.9);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border-soft: rgba(255,255,255,0.1);
}


/* ================= CONTAINER ================= */
.checkout-container {
    max-width: 880px;
    margin: 90px auto;
    padding: 36px;
    border-radius: 28px;
    background: var(--bg-card);
    backdrop-filter: blur(14px);
    box-shadow: 
        0 40px 80px rgba(0,0,0,0.12),
        inset 0 0 0 1px var(--border-soft);
}

/* ================= HEADER ================= */
.checkout-container h2 {
    font-size: 32px;
    margin-bottom: 8px;
    color: var(--text-main);
}

.user-info {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 26px;
}

.user-info strong {
    color: var(--text-main);
}

/* ================= CART LIST ================= */
.cart-list {
    border-top: 1px dashed var(--border-soft);
    border-bottom: 1px dashed var(--border-soft);
    padding: 20px 0;
    margin-bottom: 24px;
}

.cart-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 16px;
    color: var(--text-main);
}

.cart-item span:last-child {
    font-weight: 600;
}

/* ================= TOTAL BOX ================= */
.total-box {
    display: grid;
    row-gap: 12px;
    font-size: 15px;
    color: var(--text-muted);
}

.total-box div {
    display: flex;
    justify-content: space-between;
}

.total-box hr {
    border: none;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--border-soft), transparent);
    margin: 16px 0;
}

.total-box strong {
    font-size: 22px;
    color: var(--text-main);
}

/* ================= BUTTON ================= */
.checkout-btn {
    margin-top: 36px;
    width: 100%;
    padding: 18px;
    border-radius: 22px;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.5px;
    background: linear-gradient(var(--primary-dark));
    color: white;
    border: none;
    cursor: pointer;
    {% comment %} box-shadow: 
        0 16px 30px rgba(34,197,94,0.45),
        inset 0 -2px 0 rgba(0,0,0,0.15); {% endcomment %}
    transition: all 0.25s ease;
}

.checkout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 22px 40px rgba(34,197,94,0.55),
        inset 0 -2px 0 rgba(0,0,0,0.2);
}

.checkout-btn:active {
    transform: scale(0.98);
}

/* ================= MOBILE ================= */
@media (max-width: 768px) {
    .checkout-container {
        margin: 40px 16px;
        padding: 24px;
    }

    .checkout-container h2 {
        font-size: 26px;
    }

    .total-box strong {
        font-size: 20px;
    }
}

/* ================= CHECKOUT HEADER ================= */
.checkout-header {
    text-align: center;
    margin-bottom: 30px;
}

.checkout-header h2 {
    font-size: 34px;
    font-weight: 800;
    color: var(--text-main);
    margin-bottom: 6px;
}

.checkout-header .user-info {
    font-size: 15px;
    color: var(--text-muted);
}

.checkout-header .user-info strong {
    color: var(--text-main);
    font-weight: 600;
}

.checkout-header::after {
    content: "";
    display: block;
    width: 80px;
    height: 4px;
    background: linear-gradient(to right, #22c55e, #16a34a);
    border-radius: 10px;
    margin: 16px auto 0;
}


.section-box{
  margin-top: 22px;
  padding: 18px;
  border-radius: 18px;
  border: 1px solid var(--border-soft);
  background: rgba(255,255,255,0.55);
}

body[data-theme="dark"] .section-box{
  background: rgba(0,0,0,0.25);
}

.section-title{
  margin: 0 0 12px;
  font-size: 18px;
  color: var(--text-main);
}

.cart-left{
  display:flex;
  align-items:center;
  gap:12px;
}

.cart-thumb{
  width:54px;
  height:54px;
  border-radius: 14px;
  object-fit: cover;
  border: 1px solid var(--border-soft);
}

.cart-meta .cart-name{
  font-weight: 700;
}

.cart-meta .cart-qty{
  font-size: 13px;
  color: var(--text-muted);
}

.cart-price{
  font-weight: 800;
}

.address-list{
  display: grid;
  gap: 12px;
}

.address-card, .pay-card{
  display:flex;
  gap: 12px;
  padding: 14px;
  border-radius: 16px;
  border: 1px solid var(--border-soft);
  cursor: pointer;
  align-items: flex-start;
  background: rgba(255,255,255,0.65);
}

body[data-theme="dark"] .address-card,
body[data-theme="dark"] .pay-card{
  background: rgba(0,0,0,0.25);
}

.address-card input, .pay-card input{
  margin-top: 3px;
  transform: scale(1.1);
}

.addr-line{
  color: var(--text-main);
  font-size: 14px;
}

.empty-note{
  color: var(--text-muted);
  font-size: 14px;
}

.add-address{
  margin-top: 16px;
  padding-top: 12px;
  border-top: 1px dashed var(--border-soft);
}

.add-address h4{
  margin: 0 0 10px;
  color: var(--text-main);
}

.grid-2{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 10px;
}

.grid-2 input{
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid var(--border-soft);
  outline: none;
}

.mini-btn{
  border: none;
  border-radius: 14px;
  font-weight: 700;
  background: var(--primary);
  color: white;
  cursor: pointer;
}

.hint{
  margin-top: 8px;
  font-size: 13px;
  color: var(--text-muted);
}

.pay-title{
  font-weight: 800;
  color: var(--text-main);
}

.pay-sub{
  font-size: 13px;
  color: var(--text-muted);
}

@media (max-width: 768px){
  .grid-2{ grid-template-columns: 1fr; }
}

.default-badge{
  margin-left: 8px;
  font-size: 12px;
  font-weight: 800;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(34,197,94,0.15);
  border: 1px solid rgba(34,197,94,0.35);
  color: var(--text-main);
}

.address-card:has(input:checked){
  border: 1px solid rgba(34,197,94,0.55);
  box-shadow: 0 10px 25px rgba(34,197,94,0.12);
}

</style>

</head>

<body>
<!-- ================= HEADER ================= -->

<!-- Header -->
    <header class="header">
        <div class="brand">
            <a href="{% url 'home' %}" class="logo-link">
                <img src="{% static 'images/logoo.png' %}" alt="Crave Cart Logo" class="logo">
            </a>
        </div>
        <div class="header-actions">

    <!-- HELP -->
    <a href="{% url 'about' %}" class="icon-btn" title="About Us" aria-label="About Us">
    <span class="icon">‚ÑπÔ∏è</span>
    </a>

    <!-- THEME TOGGLE -->
    <button class="icon-btn theme-btn" onclick="toggleTheme()" title="Toggle theme">
        <span class="icon" id="themeIcon">üåô</span>
    </button>



    <!-- CART (BETWEEN THEME & PROFILE) -->
    {% if request.session.username %}
        <a href="{% url 'view_cart' %}" class="icon-btn cart-btn" title="Cart">
            <span class="cart-icon-box">
                <img
                    id="cartIcon"
                    alt="Cart"
                >
                {% if cart_count and cart_count > 0 %}
                    <span class="cart-count">{{ cart_count }}</span>
                {% endif %}
            </span>
        </a>
    {% endif %}


    <!-- PROFILE -->
    <div class="profile-menu">
        <button class="profile-avatar" onclick="toggleProfileMenu(event)">
            <span class="icon">
                <img
                src="{% if nav_profile.profile_photo %}{{ nav_profile.profile_photo.url }}{% else %}{% static 'images/profile.png' %}{% endif %}"
                alt="Profile"
                class="nav-avatar-img"
                >

            </span>
        </button>

        <!-- DROPDOWN -->
        <div class="profile-dropdown" id="profileDropdown">

            <!-- USER INFO -->
            <div class="profile-header">
                <img
                    src="{% if nav_profile.profile_photo %}{{ nav_profile.profile_photo.url }}{% else %}{% static 'images/profile.png' %}{% endif %}"
                    class="profile-pic"
                    alt="User"
                >
                <div class="profile-meta">
                    <strong class="profile-name">{{ nav_user.username|capfirst }}</strong>
                </div>
                </div>



            <div class="dropdown-divider"></div>

            <!-- MENU -->
                <a href="{% url 'profile'%}" class="dropdown-item">üë§ My Profile</a>
                <a href="{% url 'open_customer_show_restaurants' %}" class="dropdown-item">üè† Home</a>
                <a href="{% url 'order_history' %}" class="dropdown-item">üõí Order History</a>

            <div class="dropdown-divider"></div>

            <a href="javascript:void(0)"
                    class="dropdown-item logout"
                    onclick="openLogoutModal()">
                    üö™ Log Out
             </a>

        </div>
    </div>
</div>
    </header>
    
<div class="checkout-container">

    <div class="checkout-header">
    <h2>Checkout</h2>
    <div class="user-info">
        Logged in as: <strong>{{ customer.username }}</strong>
    </div>
</div>


    <div class="cart-list">
  {% for ci in cart_items %}
    <div class="cart-item">
      <div class="cart-left">
        <img class="cart-thumb"
            src="{% if ci.item.picture_file %}{{ ci.item.picture_file.url }}{% elif ci.item.picture %}{{ ci.item.picture }}{% else %}{% static 'images/default_food.png' %}{% endif %}"
            alt="{{ ci.item.name }}">
        <div class="cart-meta">
          <div class="cart-name">{{ ci.item.name }}</div>
          <div class="cart-qty">Qty: {{ ci.quantity }}</div>
        </div>
      </div>

      <div class="cart-price">‚Çπ{{ ci.item.price|floatformat:2 }}</div>
    </div>
  {% endfor %}
</div>

<form id="checkoutForm">
  <!-- ADDRESS -->
  <div class="section-box">
  <h3 class="section-title">Delivery Address</h3>

  <div class="address-list">
    {% for addr in addresses %}
      <label class="address-card">
        <input type="radio" name="address_id" value="{{ addr.id }}"
          {% if default_address_id %}
              {% if addr.id == default_address_id %}checked{% endif %}
          {% else %}
              {% if forloop.first %}checked{% endif %}
          {% endif %}
        >

        <div class="address-body">
          <div class="addr-line">
            <strong>{{ addr.label }}</strong>
            {% if addr.is_default %}
              <span class="default-badge">DEFAULT</span>
            {% endif %}
          </div>
          <div class="addr-line">{{ addr.address }}</div>
        </div>
      </label>
    {% empty %}
      <div class="empty-note">No saved addresses found.</div>
    {% endfor %}
  </div>
</div>


  <!-- PAYMENT -->
  <div class="section-box">
  <h3 class="section-title">Payment Method</h3>

  <div class="pay-options">
    <label class="pay-card">
      <input type="radio" name="pay_method" value="ONLINE" checked>
      <div>
        <div class="pay-title">Pay Online (UPI / Card / NetBanking)</div>
        <div class="pay-sub">Razorpay Checkout</div>
      </div>
    </label>

    <label class="pay-card">
      <input type="radio" name="pay_method" value="COD">
      <div>
        <div class="pay-title">Cash on Delivery</div>
        <div class="pay-sub">Pay after delivery</div>
      </div>
    </label>
  </div>
</div>

</form>


    <div class="total-box">
    <div>Items Total <span>‚Çπ{{ product_total }}</span></div>
    <div>Delivery <span>‚Çπ{{ delivery_fee }}</span></div>
    <div>GST (5%) <span>‚Çπ{{ gst }}</span></div>
    {% if coupon_discount %}
    <div>Coupon Discount <span>-‚Çπ{{ coupon_discount }}</span></div>
    {% endif %}
    <hr>
    <div><strong>Total</strong> <strong>‚Çπ{{ grand_total }}</strong></div>
</div>


    <!-- Razorpay Button -->
    <button id="place-order-btn" class="checkout-btn">
    CONTINUE
    </button>


</div>
<footer class="footer">
    ¬© 2025 Crave Cart
</footer>
<!-- ================= LOGOUT MODAL ================= -->
<div class="logout-overlay" id="logoutOverlay">
    <div class="logout-modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>
        <button class="btn primary full-width" onclick="confirmLogout()">
            Yes, Log Out
        </button>
    </div>
</div>

<!-- ================= JS ================= -->
<script src="{% static 'js/theme.js' %}"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
const CART_LIGHT = "{% static 'images/dark-cart.png' %}";
const CART_DARK  = "{% static 'images/light-cart.png' %}";

/* ================= CSRF HELPER ================= */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

/* ================= SAVE NEW ADDRESS ================= */
function saveNewAddress() {
  const payload = {
    name: document.getElementById("a_name").value.trim(),
    mobile: document.getElementById("a_mobile").value.trim(),
    house_no: document.getElementById("a_house").value.trim(),
    area: document.getElementById("a_area").value.trim(),
    city: document.getElementById("a_city").value.trim(),
    state: document.getElementById("a_state").value.trim(),
    pincode: document.getElementById("a_pin").value.trim(),
  };

  fetch("{% url 'add_address_ajax' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/json",
    },
    body: JSON.stringify(payload),
  })
  .then(r => r.json())
  .then(data => {
    const msg = document.getElementById("addrMsg");
    if (data.ok) {
      msg.textContent = "‚úÖ Address saved. Refreshing...";
      window.location.reload();
    } else {
      msg.textContent = "‚ùå " + (data.error || "Unable to save address");
    }
  })
  .catch(() => {
    document.getElementById("addrMsg").textContent = "‚ùå Network error";
  });
}

/* ================= RAZORPAY OPTIONS ================= */
var options = {
  key: "{{ razorpay_key_id }}",
  order_id: "{{ order_id }}",
  currency: "INR",
  name: "Crave Cart",
  description: "Order Payment",
  handler: function (response) {
    fetch("{% url 'payment_success' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/json"
      },
      body: JSON.stringify(response)
    })
    .then(() => window.location.href = "{% url 'order_history' %}");
  }
};

var rzp = new Razorpay(options);

/* ================= PLACE ORDER CLICK ================= */
document.getElementById("place-order-btn").onclick = function (e) {
  e.preventDefault();

  const addressId = document.querySelector('input[name="address_id"]:checked')?.value;
  const payMethod = document.querySelector('input[name="pay_method"]:checked')?.value;

  if (!addressId) {
    alert("Please select a delivery address.");
    return;
  }

  // Save selected address + payment method in backend before payment
  fetch("{% url 'set_checkout_selection' %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": getCookie("csrftoken"),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ address_id: addressId, pay_method: payMethod })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) {
      alert(data.error || "Something went wrong");
      return;
    }

    // COD flow
    if (payMethod === "COD") {
        window.location.href = "{% url 'place_cod_order' %}";
        return;
        }


    // ONLINE flow (Razorpay supports UPI inside)
    rzp.open();
  });
};


</script>


</body>
</html>
